{% extends "admin/function_page_base.html" %}

{% block title %}Shop Image Generator{% endblock %}

{% block content %}
<style>
  /* Make file inputs fill their drop-zones but be invisible */
  #drop-zone, #drop-zone-img, #drop-zone-zip {
    position: relative;
    border: 2px dashed #ffffff;
    padding: 30px;
    text-align: center;
    color: #ffffff;
    border-radius: 8px;
    margin-bottom: 20px;
    cursor: pointer;
  }
  #drop-zone input,
  #drop-zone-img input,
  #drop-zone-zip input {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%; height: 100%;
    opacity: 0;
  }
</style>

{# Hidden preview form #}
<form
  id="preview_form"
  method="post"
  action="{% url 'sample_processing' %}"
  enctype="multipart/form-data"
  style="display:none;"
>
  {% csrf_token %}
</form>

{# Main processing form #}
<form
  id="main_form"
  method="post"
  action="{% url 'main_processing' %}"
  enctype="multipart/form-data"
  autocomplete="off"
>
  {% csrf_token %}

  <h1 class="module__title" style="font-size:32px; font-weight:bold; color:#4e738d;">
    Shop Image Generator
  </h1>

  {% if processed %}
    <div class="module" style="margin-top:40px;">
      <h2 class="module__subtitle" style="font-size:24px; font-weight:600; color:#ffffff;">
        Processing Complete (Time Taken: {{ elapsed_time }})
      </h2>
      <a href="{{ zip_path }}" download><button type="button" style="margin:10px;">Download ZIP</button></a>
      <a href="{{ log_path }}" download><button type="button" style="margin:10px;">Download Error Log</button></a>
      <a href="{{ normal_path }}" download><button type="button" style="margin:10px;">Download Renamed Images</button></a>
    </div>
  {% endif %}

  {# Section 1: Manufacturer #}
  <div class="module">
    <label for="manufacturer_logo" style="font-size:18px; color:#ffffff;">
      1. Select Manufacturer Logo
    </label>
    <select id="manufacturer_logo" name="manufacturer_dropdown" required
            style="margin-top:5px; font-size:16px; padding:8px; border-radius:4px; width:100%; border:1px solid #ffffff;">
      <option value="no image">-- Select a manufacturer --</option>
      {% for m in manufacturers %}
        <option value="{{ m.name }}">{{ m.name }}</option>
      {% endfor %}
    </select>
  </div>

  {# Section 2: CSV/XLSX #}
  <div class="module">
    <h2 class="module__subtitle" style="font-size:24px; font-weight:600; color:#ffffff;">
      2. Upload CSV/XLSX Mapping File
    </h2>
    <p style="font-size:16px; color:#ffffff; margin-bottom:8px;">
      Allowed formats: <code>.csv</code>, <code>.xlsx</code> (drag & drop or click).
    </p>
    <div id="drop-zone">
      Drop or click to select your mapping file
      <input type="file" id="mapping_csv" name="mapping_csv" accept=".csv,.xlsx" required />
      <p id="file-name" style="margin-top:10px; font-size:14px; color:#00ffcc;"></p>
    </div>
  </div>

  {# Section 3: Preview Image #}
  <div class="module">
    <h2 class="module__subtitle" style="font-size:24px; font-weight:600; color:#ffffff;">
      3. Upload Sample Product Image (optional)
    </h2>
    <p style="font-size:16px; color:#ffffff; margin-bottom:8px;">
      For preview only; will not be processed.
    </p>
    <div id="drop-zone-img">
      Drop or click to select your sample image
      <input type="file" id="sample_prod_img" name="sample_prod_img"
             form="preview_form" accept="image/*" />
      <p id="file-name-img" style="margin-top:10px; font-size:14px; color:#00ffcc;"></p>
    </div>
    <button form="preview_form" type="submit"
            style="font-size:16px; padding:10px 20px; background:rgba(0,0,0,0.7); color:white; border-radius:4px;">
      Generate Preview
    </button>
    {% if processed1 %}
      <img src="{{ img }}" alt="Preview" width="10%" height="10%"
           style="margin-top:20px; border:1px solid #ffffff;" />
    {% endif %}
  </div>

  {# Section 4: Configure Settings #}
  <div class="module">
    <h2 class="module__subtitle" style="font-size:24px; font-weight:600; color:#ffffff;">
      4. Configure Image Settings
    </h2>
    <div class="form-row" style="display:flex; gap:20px; margin-top:20px;">
      <div style="flex:1; min-width:200px;"><label for="canvas_width" style="font-size:18px; color:#ffffff;">Canvas Width (px)</label>
        <input type="number" id="canvas_width" name="canvas_width" required min="1" value="1000"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
      <div style="flex:1; min-width:200px;"><label for="canvas_height" style="font-size:18px; color:#ffffff;">Canvas Height (px)</label>
        <input type="number" id="canvas_height" name="canvas_height" required min="1" value="1000"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
      <div style="flex:1; min-width:200px;"><label for="logo_top_margin" style="font-size:18px; color:#ffffff;">Logo Top Margin (px)</label>
        <input type="number" id="logo_top_margin" name="logo_top_margin" required min="1" value="50"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
    </div>
    <div class="form-row" style="display:flex; gap:20px; margin-top:20px;">
      <div style="flex:1; min-width:200px;"><label for="logo_right_margin" style="font-size:18px; color:#ffffff;">Logo Right Margin (px)</label>
        <input type="number" id="logo_right_margin" name="logo_right_margin" required min="1" value="50"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
      <div style="flex:1; min-width:200px;"><label for="product_left_margin" style="font-size:18px; color:#ffffff;">Product Left Margin (px)</label>
        <input type="number" id="product_left_margin" name="product_left_margin" required min="1" value="50"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
      <div style="flex:1; min-width:200px;"><label for="product_bottom_margin" style="font-size:18px; color:#ffffff;">Product Bottom Margin (px)</label>
        <input type="number" id="product_bottom_margin" name="product_bottom_margin" required min="1" value="50"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
    </div>
    <div class="form-row" style="display:flex; gap:20px; margin-top:20px;">
      <div style="flex:1; min-width:200px;"><label for="logo_max_width" style="font-size:18px; color:#ffffff;">Logo Max Width (px)</label>
        <input type="number" id="logo_max_width" name="logo_max_width" required min="1" value="200"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
      <div style="flex:1; min-width:200px;"><label for="product_max_height" style="font-size:18px; color:#ffffff;">Product Max Height (px)</label>
        <input type="number" id="product_max_height" name="product_max_height" required min="1" value="500"
               style="width:100%; padding:10px; border-radius:4px;" />
      </div>
    </div>
  </div>

  {# Section 5: Process Images #}
  <div class="module">
    <h2 class="module__subtitle" style="font-size:24px; font-weight:600; color:#ffffff;">
      5. Process Product Images
    </h2>
    <p style="font-size:16px; color:#ffffff; margin-bottom:8px;">Upload a ZIP of product images:</p>
    <div id="drop-zone-zip">
      Drop or click to select your ZIP file
      <input type="file" id="images_zip" name="images_zip" accept=".zip" required />
      <p id="file-name-zip" style="margin-top:10px; font-size:14px; color:#00ffcc;"></p>
    </div>


    <button type="submit" name="process" style="font-size:16px; padding:10px 20px; background:#4e738d; color:white; border-radius:4px;">
      Process Images
    </button>
  </div>
</form>

<script>
  // Sync preview form hidden fields
  document.getElementById('preview_form').addEventListener('submit', function() {
    ['manufacturer_dropdown','canvas_width','canvas_height','logo_top_margin','logo_right_margin','logo_max_width','product_left_margin','product_bottom_margin','product_max_height']
    .forEach(name => {
      const src = document.querySelector(`[name="${name}"]`);
      if (!src) return;
      let hid = this.querySelector(`input[name="${name}"]`);
      if (!hid) { hid = document.createElement('input'); hid.type='hidden'; hid.name=name; this.appendChild(hid); }
      hid.value = src.value;
    });
  });

  // Drag & drop handlers + polling
  document.addEventListener('DOMContentLoaded', () => {
    [{zone:'drop-zone',inp:'mapping_csv',name:'file-name'},
     {zone:'drop-zone-img',inp:'sample_prod_img',name:'file-name-img'},
     {zone:'drop-zone-zip',inp:'images_zip',name:'file-name-zip'}]
    .forEach(({zone,inp,name}) => {
      const z=document.getElementById(zone), i=document.getElementById(inp), n=document.getElementById(name);
      ['dragenter','dragover','dragleave','drop'].forEach(e=>z.addEventListener(e,ev=>{ev.preventDefault();ev.stopPropagation();}));
      z.addEventListener('drop',ev=>{i.files=ev.dataTransfer.files; if(i.files.length) n.textContent=`Selected: ${i.files[0].name}`});
      i.addEventListener('change',()=>{ if(i.files.length) n.textContent=`Selected: ${i.files[0].name}` });
      z.addEventListener('click',()=>i.click());
    });
  });
</script>
{% endblock %}
